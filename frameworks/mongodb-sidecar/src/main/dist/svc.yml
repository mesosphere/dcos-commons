name: "{{SERVICE_NAME}}"
web-url: "http://sidecar-0-companion.{{SERVICE_NAME}}.mesos:{{SIDECAR_PORT}}"
scheduler:
  principal: "{{SERVICE_NAME}}-principal"
  api-port: {{PORT_API}}
pods:
  mongodb:
    count: {{MONGODB_COUNT}}
    resource-sets:
      mongodb-resources:
        cpus: {{MONGODB_CPUS}}
        memory: {{MONGODB_MEM}}
        ports:
          mongodb-port:
            port: {{MONGODB_PORT}}
            vip:
              prefix: "{{SERVICE_NAME}}"
              port: {{MONGODB_PORT}}
          "{{SERVICE_NAME}}-rest":
            port: {{MONGODB_REST_PORT}}
        volume:
          path: "mongodb-replicaset"
          type: ROOT
          size: {{MONGODB_DISK}}
    tasks:
      server:
        resource-set: mongodb-resources
        goal: RUNNING
        cmd: "env && exec $MESOS_SANDBOX/mongodb-linux-x86_64-{{MONGODB_VERSION}}/bin/mongod --rest --bind_ip $LIBPROCESS_IP --port {{MONGODB_PORT}} --dbpath $MESOS_SANDBOX/mongodb-replicaset --replSet {{MONGODB_REPLSET}}"
        uris:
          - "https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-{{MONGODB_VERSION}}.tgz"
        health-check:
           cmd: "curl --fail ${LIBPROCESS_IP}:{{MONGODB_PORT}} > /dev/null"
           interval: 30
           grace-period: 60
           max-consecutive-failures: 5
           delay: 5
           timeout: 5
  sidecar:
    count: {{SIDECAR_COUNT}}
    container:
      image-name: {{SIDECAR_IMAGE}}
    tasks:
      companion:
        cpus: {{SIDECAR_CPUS}}
        memory: {{SIDECAR_MEM}}
        goal: RUNNING
        cmd: {{SIDECAR_CMD}}
        ports:
          sidecar:
            port: 4567
        env:
          APP_NAME: {{SIDECAR_APP_NAME}}
          DELAY: {{SIDECAR_DELAY}}
          ZK_URL: {{SIDECAR_ZK_URL}}
          MESOS_URL: {{SIDECAR_MESOS_URL}}
          LOG_LEVEL: {{SIDECAR_LOG_LEVEL}}
          MONGO_BINARY: "/mnt/mesos/sandbox/mongodb-linux-x86_64-{{MONGODB_VERSION}}/bin/mongo"
        uris:
          - "https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-{{MONGODB_VERSION}}.tgz"

plans:
  deploy:
    strategy: parallel
    phases:
      mongodb-deploy:
        strategy: parallel
        pod: mongodb
      sidecar-deploy:
        strategy: serial
        pod: sidecar
