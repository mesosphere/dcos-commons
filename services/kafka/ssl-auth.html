<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">








<head>
<title>Kafka: SSL Auth</title>
<link rel="stylesheet" type="text/css" media="all" href="../../style/layout.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="../../style/Dropdown.css" />
<script src="../../style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
.section-nav ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="../..">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />

<ul class="dropdown" style="clear: both">
  <li>
    <a href="../..">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      
      <li><a href="../../operations-guide.html">SDK Operations Guide</a></li>
      
      
      
      
      
      <li><a href="../../developer-guide.html">SDK Developer Guide</a></li>
      
      
      
      <li><a href="../../yaml-reference.html">YAML Reference</a></li>
      
      
      
      <li><a href="../../faq.html">Frequently Asked Questions</a></li>
      
      
      
      <li><a href="../../glossary.html">Glossary</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li><a href="../../reference/api">Javadoc Reference</a></li>
      <li><a href="../../reference/swagger-api">REST APIs</a></li>
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="../../tutorials/secrets-tutorial.html">Secrets Tutorial</a></li>
      
      <li><a href="../../tutorials/kafka-tutorial.html">Kafka Tutorial</a></li>
      
    </ul>
  </li>
  <li>
    <span>Services</span>
    <ul>
      
      
      
      
      <li>
        
        <span>Cassandra</span>
        
        <ul>
          
          
          
          <li><a href="../../services/cassandra/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../../services/cassandra/service-settings.html">Service Settings</a></li>
          
          
          
          <li><a href="../../services/cassandra/cassandra-settings.html">Cassandra Settings</a></li>
          
          
          
          <li><a href="../../services/cassandra/node-settings.html">Node Settings</a></li>
          
          
          
          <li><a href="../../services/cassandra/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../../services/cassandra/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../../services/cassandra/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../../services/cassandra/managing.html">Managing</a></li>
          
          
          
          <li><a href="../../services/cassandra/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../../services/cassandra/disaster-recovery.html">Disaster Recovery</a></li>
          
          
          
          <li><a href="../../services/cassandra/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../../services/cassandra/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../../services/cassandra/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../../services/cassandra/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../../services/cassandra/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Elastic</span>
        
        <ul>
          
          
          
          <li><a href="../../services/elastic/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../../services/elastic/elastic-x-pack.html">X-Pack</a></li>
          
          
          
          <li><a href="../../services/elastic/custom-elasticsearch-yaml.html">Custom Elasticsearch YAML</a></li>
          
          
          
          <li><a href="../../services/elastic/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../../services/elastic/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../../services/elastic/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../../services/elastic/managing.html">Managing</a></li>
          
          
          
          <li><a href="../../services/elastic/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../../services/elastic/disaster-recovery.html">Disaster Recovery</a></li>
          
          
          
          <li><a href="../../services/elastic/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../../services/elastic/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../../services/elastic/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../../services/elastic/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../../services/elastic/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>HDFS</span>
        
        <ul>
          
          
          
          <li><a href="../../services/hdfs/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../../services/hdfs/kerberos.html">Kerberos</a></li>
          
          
          
          <li><a href="../../services/hdfs/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../../services/hdfs/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../../services/hdfs/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../../services/hdfs/managing.html">Managing</a></li>
          
          
          
          <li><a href="../../services/hdfs/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../../services/hdfs/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../../services/hdfs/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../../services/hdfs/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../../services/hdfs/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../../services/hdfs/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
      <li>
        
        <span>Kafka</span>
        
        <ul>
          
          
          
          <li><a href="../../services/kafka/install.html">Install and Customize</a></li>
          
          
          
          <li><a href="../../services/kafka/kerberos.html">Kerberos</a></li>
          
          
          
          <li><a href="../../services/kafka/ssl-auth.html">SSL Auth</a></li>
          
          
          
          <li><a href="../../services/kafka/uninstall.html">Uninstall</a></li>
          
          
          
          <li><a href="../../services/kafka/quick-start.html">Quick Start</a></li>
          
          
          
          <li><a href="../../services/kafka/connecting-clients.html">Connecting Clients</a></li>
          
          
          
          <li><a href="../../services/kafka/managing.html">Managing</a></li>
          
          
          
          <li><a href="../../services/kafka/api-reference.html">API Reference</a></li>
          
          
          
          <li><a href="../../services/kafka/troubleshooting.html">Troubleshooting</a></li>
          
          
          
          <li><a href="../../services/kafka/limitations.html">Limitations</a></li>
          
          
          
          <li><a href="../../services/kafka/supported-versions.html">Supported Versions</a></li>
          
          
          
          <li><a href="../../services/kafka/release-notes.html">Release Notes</a></li>
          
          
          
          <li><a href="../../services/kafka/upgrade.html">Upgrade</a></li>
          
          
        </ul>
      </li>
      
    </ul>
  </li>
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>Kafka: SSL Auth</h1>
<div id="content">

<h2 id="how-to-connect-an-authenticated-client">How to connect an authenticated client</h2>

<h3 id="create-a-dcos-ca-signed-certificate-note-this-can-be-replaced-with-some-enterprise-cli-calls">Create a DC/OS CA signed certificate (Note: This can be replaced with some enterprise CLI calls)</h3>

<h4 id="manually">Manually</h4>
<ol>
  <li>Generate a private key
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl genrsa <span class="nt">-out</span> priv.key 2048
</code></pre></div>    </div>
  </li>
  <li>Generate a CSR. Note: The <code class="highlighter-rouge">principal</code> of the TLS cert is the values of the CSR (e.g. CN=host1.example.com,OU=,O=Confluent,L=London,ST=London,C=GB)
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>openssl req <span class="nt">-new</span> <span class="nt">-sha256</span> <span class="nt">-key</span> priv.key <span class="nt">-out</span> request.csr
</code></pre></div>    </div>
  </li>
  <li>Make a request to the DC/OS CA
```bash
    <h1 id="request">Request</h1>
    <p>$ curl -X POST \
  -H “Authorization: token=$(dcos config show core.dcos_acs_token)” \
  http://YOURCLUSTER.com/ca/api/v2/sign \
  -d ‘{“certificate_request”: “<json-encoded-value-of-request.csr>"}'</json-encoded-value-of-request.csr></p>
  </li>
</ol>

<h1 id="response">Response</h1>
<p>{“success”:true,”result”:{“certificate”:”&lt;json-encoded-public-key”},”errors”:[],”messages”:[]}</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>4. Decode the JSON and save the generated certificate to `pub.crt`

#### Using the Enterprise CLI
1. Install the DC/OS Enterprise CLI
```bash
$ dcos package install dcos-enterprise-cli --yes
</code></pre></div></div>
<ol>
  <li>Create a signed certificate
```bash
$ dcos security cluster ca newcert –cn test –host test
certificate: ‘<Cert>'
certificate_request: '<CSR>'
private_key: '<Private Key=""> '</Private></CSR></Cert></li>
</ol>

<h1 id="note-right-now-these-output-with-extra-newlines-">Note: right now these output with extra newlines :(</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Install Kafka with TLS Auth Enabled
1. Create a DC/OS Service Account
```bash
# Install the enterprise CLI
$ dcos package install dcos-enterprise-cli --yes

# Create a service account
$ dcos security org service-accounts keypair priv.pem pub.pem
$ dcos security org service-accounts create -p pub.pem -d "testing" service-acct

# Set the service account secret
$ dcos security secrets create-sa-secret priv.pem service-acct secret

# Grant it superuser permissions (required for TLS currently)
$ dcos security org users grant service-acct dcos:superuser full
</code></pre></div></div>
<ol>
  <li>Install the Kafka package
```bash
$ vi /tmp/options.json
{
  “service”: {
 “name”: “kafka”,
 “service_account”: “service-acct”,
 “service_account_secret”: “secret”,
 “security”: {
   “transport_encryption”: {
     “enabled”: true
   },
   “ssl_authentication”: {
     “enabled”: true
   }
 }
  }
}</li>
</ol>

<p>$ dcos package install beta-kafka –options=/tmp/options.json</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
### Connect a client
0. Get the VIP from the endpoints API
```bash
$ dcos beta-kafka --name=kafka endpoints broker-tls

{
  "address": [
    "10.0.1.168:1025",
    "10.0.3.145:1025",
    "10.0.2.176:1025"
  ],
  "dns": [
    "kafka-0-broker.kafka.autoip.dcos.thisdcos.directory:1025",
    "kafka-1-broker.kafka.autoip.dcos.thisdcos.directory:1025",
    "kafka-2-broker.kafka.autoip.dcos.thisdcos.directory:1025"
  ],
  "vip": "broker-tls.kafka.l4lb.thisdcos.directory:9093"
}
</code></pre></div></div>
<ol>
  <li>SSH to the leader
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos node ssh <span class="nt">--master-proxy</span> <span class="nt">--leader</span>
</code></pre></div>    </div>
  </li>
  <li>Copy over the content of pub.crt and priv.key via copy/paste</li>
  <li>Copy the ca bundle to the working directory
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> /run/dcos/pki/CA/ca-bundle.crt <span class="nb">.</span>
</code></pre></div>    </div>
  </li>
  <li>Convert the pub/priv keypair to a PKCS12 key
```bash
$ openssl pkcs12 -export -in pub.crt -inkey priv.key \
            -out keypair.p12 -name keypair \
            -CAfile ca-bundle.crt -caname root</li>
</ol>

<h1 id="when-prompted-set-the-password-to-export">When prompted, set the password to “export”</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5. Run the kafka docker image
```bash
$ docker run --rm -ti \
    -v /home/core:/tmp \
    -w /opt/kafka/bin \
    wurstmeister/kafka \
    bash
</code></pre></div></div>
<ol>
  <li>Create the keystore
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>keytool <span class="nt">-importkeystore</span> <span class="se">\</span>
     <span class="nt">-deststorepass</span> changeit <span class="nt">-destkeypass</span> changeit <span class="nt">-destkeystore</span> /tmp/keystore.jks <span class="se">\</span>
     <span class="nt">-srckeystore</span> /tmp/keypair.p12 <span class="nt">-srcstoretype</span> PKCS12 <span class="nt">-srcstorepass</span> <span class="nb">export</span> <span class="se">\</span>
     <span class="nt">-alias</span> keypair
</code></pre></div>    </div>
  </li>
  <li>Create the truststore
```bash
$ keytool -import \
  -trustcacerts \
  -alias root \
  -file /tmp/ca-bundle.crt \
  -storepass changeit \
  -keystore /tmp/truststore.jks</li>
</ol>

<h1 id="youll-be-prompted-to-trust-a-cert-just-say-yes-">You’ll be prompted to trust a cert. Just say yes :)</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>8. Write the client config
```bash
$ cat &gt;/tmp/client.properties &lt;&lt; EOL
security.protocol = SSL
ssl.truststore.location = /tmp/truststore.jks
ssl.truststore.password = changeit
ssl.keystore.location = /tmp/keystore.jks
ssl.keystore.password = changeit
EOL
</code></pre></div></div>
<ol>
  <li>Open a second terminal. SSH to the master. Start the docker container with the same command in step 5.</li>
  <li>Start the consumer in one terminal, and the producer in another
```bash
    <h1 id="terminal-session-1">Terminal session 1</h1>
    <p>$ ./kafka-console-producer.sh \
  –broker-list broker-tls.kafka.l4lb.thisdcos.directory:9093 \
  –topic test \
  –producer.config /tmp/client.properties</p>
  </li>
</ol>

<h1 id="terminal-session-2">Terminal session 2</h1>
<p>$ ./kafka-console-consumer.sh \
  –bootstrap-server broker-tls.kafka.l4lb.thisdcos.directory:9093 \
  –topic test \
  –consumer.config /tmp/client.properties
```</p>
<ol>
  <li>Send messages to your heart’s content. Note: Starting the producer will create the topic test, but it will take the consumer a few moments to be happy (a leader for the test topic must be elected).</li>
</ol>

<h4 id="references">References</h4>
<ul>
  <li>https://docs.mesosphere.com/1.10/cli/enterprise-cli/#ent-cli-install</li>
  <li>https://docs.mesosphere.com/1.10/security/service-auth/custom-service-auth/</li>
  <li>https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.6.2/bk_security/content/ch_wire-kafka.html</li>
  <li>https://www.confluent.io/blog/apache-kafka-security-authorization-authentication-encryption/</li>
  <li>https://stackoverflow.com/questions/906402/how-to-import-an-existing-x509-certificate-and-private-key-in-java-keystore-to-u</li>
</ul>

</div>
</div>
</body>

</html>
