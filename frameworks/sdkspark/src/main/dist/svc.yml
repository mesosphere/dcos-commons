name: {{FRAMEWORK_NAME}}
scheduler:
  principal: {{FRAMEWORK_PRINCIPAL}}
  user: {{FRAMEWORK_USER}}
pods:
  coordinator:
    count: 1
    image: {{SPARK_DOCKER_IMAGE}}
    placement: {{COORDINATOR_PLACEMENT}}
    {{#ENABLE_VIRTUAL_NETWORK}}
    networks:
      {{VIRTUAL_NETWORK_NAME}}:
        labels: {{VIRTUAL_NETWORK_PLUGIN_LABELS}}
    {{/ENABLE_VIRTUAL_NETWORK}}
    uris:
      - {{SPARK_APP_URL}}
      {{#HDFS_CONFIG_URL}}
      - {{HDFS_CONFIG_URL}}/hdfs-site.xml
      - {{HDFS_CONFIG_URL}}/core-site.xml
      {{/HDFS_CONFIG_URL}}
    tasks:
      driver:
        goal: FINISHED
        cmd: >
          ./bin/spark-submit --master mesos://zk://master.mesos:2181/mesos
          --driver-cores {{COORDINATOR_CORES}}
          --driver-memory {{COORDINATOR_MEM}}M
          --class {{SPARK_MAIN_CLASS}}
          --executor-memory {{EXECUTOR_MEM}}M
          --conf spark.driver.port=9000
          --conf spark.ssl.noCertVerification=true
          --conf spark.mesos.backend=sdk
          {{#EVENTLOG_ENABLED}}
          --conf spark.eventLog.enabled={{EVENTLOG_ENABLED}}
          --conf spark.eventLog.dir={{EVENTLOG_DIR}}
          {{/EVENTLOG_ENABLED}}
        cpus: {{COORDINATOR_CORES}}
        env:
          COORDINATOR_CORES: {{COORDINATOR_CORES}}
          COORDINATOR_MEM: {{COORDINATOR_MEM}}
          EXECUTOR_MEM: {{EXECUTOR_MEM}}
          SPARK_APP_URL: {{SPARK_APP_URL}}
          SPARK_MAIN_CLASS: {{SPARK_MAIN_CLASS}}
          EXECUTOR_CORES: {{EXECUTOR_CORES}}
          EXECUTOR_COUNT: {{EXECUTOR_COUNT}}
          APPLICATION_ARGS: {{APPLICATION_ARGS}}
        memory: {{COORDINATOR_MEM}}
        volume:
          path: "spark-sdk-container-path"
          type: {{COORDINATOR_DISK_TYPE}}
          size: {{COORDINATOR_DISK}}
  executor:
    count: {{EXECUTOR_COUNT}}
    image: {{SPARK_DOCKER_IMAGE}}
    placement: {{EXECUTOR_PLACEMENT}}
    {{#ENABLE_VIRTUAL_NETWORK}}
    networks:
      {{VIRTUAL_NETWORK_NAME}}:
        labels: {{VIRTUAL_NETWORK_PLUGIN_LABELS}}
    {{/ENABLE_VIRTUAL_NETWORK}}
    tasks:
      worker:
        goal: FINISHED
        cmd: >
          $BOOTSTRAP -resolve-hosts coordinator-0-driver.sdkspark.mesos &&
          /opt/spark/dist/./bin/spark-class org.apache.spark.executor.CoarseGrainedExecutorBackend
          --driver-url spark://CoarseGrainedScheduler@coordinator-0-driver.sdkspark.mesos:9000
          --executor-id $POD_INSTANCE_INDEX
          --hostname $(hostname -i)
          --cores {{EXECUTOR_CORES}}
          --app-id sdkdriver
        env:
          EXECUTOR_CORES: {{EXECUTOR_CORES}}
        cpus: {{EXECUTOR_CORES}}
        memory: {{EXECUTOR_MEM}}
        volume:
          path: "spark-sdk-container-path"
          type: {{EXECUTOR_DISK_TYPE}}
          size: {{EXECUTOR_DISK}}

plans:
  deploy:
    strategy: parallel
    phases:
      coordinator-deploy:
        strategy: serial
        pod: coordinator
      executor-deploy:
        strategy: parallel
        pod: executor
