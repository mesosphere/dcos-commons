package com.mesosphere.sdk.http.queries;

import com.mesosphere.sdk.config.Configuration;
import com.mesosphere.sdk.http.ResponseUtils;
import com.mesosphere.sdk.offer.LoggingUtils;
import com.mesosphere.sdk.state.ConfigStore;
import com.mesosphere.sdk.state.ConfigStoreException;
import com.mesosphere.sdk.storage.StorageError.Reason;

import org.json.JSONArray;
import org.slf4j.Logger;

import javax.ws.rs.core.Response;

import java.util.Collections;
import java.util.UUID;

/**
 * A read-only API for accessing active and inactive configurations from persistent storage.
 */
public final class ConfigQueries {

  private static final Logger LOGGER = LoggingUtils.getLogger(ConfigQueries.class);

  private ConfigQueries() {
    // Do not instantiate
  }

  /**
   * Produces an ID listing of all stored configurations.
   *
   * @param <T> The configuration type which is being stored by the service.
   */
  public static <T extends Configuration> Response getConfigurationIds(ConfigStore<T> configStore) {
    try {
      return ResponseUtils.jsonOkResponse(new JSONArray(configStore.list()));
    } catch (Exception ex) { // SUPPRESS CHECKSTYLE IllegalCatch
      LOGGER.error("Failed to fetch list of configuration ids", ex);
      return Response.serverError().build();
    }
  }

  /**
   * Produces the content of the provided configuration ID, or returns an error if that ID doesn't
   * exist or the data couldn't be read.
   */
  public static <T extends Configuration> Response getConfiguration(
      ConfigStore<T> configStore, String configurationId)
  {
    LOGGER.info("Attempting to fetch config with id '{}'", configurationId);
    UUID uuid;
    try {
      uuid = UUID.fromString(configurationId);
    } catch (IllegalArgumentException ex) {
      LOGGER.warn(String.format(
          "Failed to parse requested configuration id '%s' as a UUID", configurationId), ex);
      return Response.status(Response.Status.BAD_REQUEST).build();
    }
    try {
      return fetchConfig(configStore, uuid);
    } catch (ConfigStoreException ex) {
      if (ex.getReason() == Reason.NOT_FOUND) {
        LOGGER.warn(
            String.format(
                "Requested configuration '%s' doesn't exist",
                configurationId
            ),
            ex
        );
        return Response.status(Response.Status.NOT_FOUND).build();
      }
      LOGGER.error(String.format(
          "Failed to fetch requested configuration with id '%s'", configurationId), ex);
      return Response.serverError().build();
    }
  }

  /**
   * Produces the ID of the current target configuration, or returns an error if reading that
   * data failed.
   */
  public static <T extends Configuration> Response getTargetId(ConfigStore<T> configStore) {
    try {
      // return a JSONArray to line up with getConfigurationIds()
      JSONArray configArray = new JSONArray(
          Collections.singletonList(configStore.getTargetConfig())
      );
      return ResponseUtils.jsonOkResponse(configArray);
    } catch (ConfigStoreException ex) {
      if (ex.getReason() == Reason.NOT_FOUND) {
        LOGGER.warn("No target configuration exists", ex); // SUPPRESS CHECKSTYLE MultipleStringLiteralsCheck
        return Response.status(Response.Status.NOT_FOUND).build();
      }
      LOGGER.error("Failed to fetch target configuration", ex);
      return Response.serverError().build();
    }
  }

  /**
   * Produces the content of the current target configuration, or returns an error if reading that
   * data failed.
   */
  public static <T extends Configuration> Response getTarget(ConfigStore<T> configStore) {
    UUID targetId;
    try {
      targetId = configStore.getTargetConfig();
    } catch (ConfigStoreException ex) {
      if (ex.getReason() == Reason.NOT_FOUND) {
        LOGGER.warn("No target configuration exists", ex);
        return Response.status(Response.Status.NOT_FOUND).build();
      }
      LOGGER.error("Failed to fetch ID of target configuration", ex);
      return Response.serverError().build();
    }
    try {
      return fetchConfig(configStore, targetId);
    } catch (ConfigStoreException ex) {
      // Return 500 even if exception is NOT_FOUND: The data should be present.
      LOGGER.error(String.format("Failed to fetch target configuration '%s'", targetId), ex);
      return Response.serverError().build();
    }
  }

  /**
   * Returns an HTTP response containing the content of the requested configuration.
   */
  private static <T extends Configuration> Response fetchConfig(ConfigStore<T> configStore, UUID id)
      throws ConfigStoreException
  {
    // return the content provided by the config verbatim, treat as plaintext
    return ResponseUtils.jsonResponseBean(configStore.fetch(id), Response.Status.OK);
  }
}
