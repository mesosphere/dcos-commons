package com.mesosphere.sdk.hdfs.scheduler;

import com.mesosphere.sdk.config.TaskEnvRouter;
import com.mesosphere.sdk.offer.taskdata.EnvConstants;
import com.mesosphere.sdk.specification.yaml.TemplateUtils;
import com.mesosphere.sdk.testing.BaseServiceSpecTest;
import org.junit.Test;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.Map;

@SuppressWarnings("PMD.AvoidUsingHardCodedIP")
public class ServiceSpecTest extends BaseServiceSpecTest {

    public ServiceSpecTest() {
        super(
                "CONFIG_TEMPLATE_PATH", "hdfs-scheduler",
                "DATA_COUNT", "3",
                "DATA_CPUS", "0.3",
                "DATA_DISK", "5000",
                "DATA_DISK_TYPE", "ROOT",
                "DATA_MEM", "2048",
                "DEPLOY_STRATEGY", "parallel",
                "FRAMEWORK_LOG_LEVEL", "INFO",
                "FRAMEWORK_NAME", "hdfs",
                "HDFS_VERSION", "hadoop-2.6.0-cdh5.11.0",
                "JOURNAL_CPUS", "0.3",
                "JOURNAL_DISK", "5000",
                "JOURNAL_DISK_TYPE", "ROOT",
                "JOURNAL_LAGGING_TX_COUNT", "0",
                "JOURNAL_MEM", "2048",
                "JOURNAL_READINESS_CHECK_ENABLED", "true",
                "JRE_VERSION", "jre1.8.0_131",
                "NAME_CPUS", "0.3",
                "NAME_DISK", "5000",
                "NAME_DISK_TYPE", "ROOT",
                "NAME_MEM", "2048",
                "SERVICE_PRINCIPAL", "",
                "TASKCFG_ALL_ADMINISTRATORS", "core,centos,azureuser",
                "TASKCFG_ALL_BLOCKREPORT_INITIALDELAY", "0",
                "TASKCFG_ALL_BLOCKREPORT_INTERVALMSEC", "21600000",
                "TASKCFG_ALL_BLOCKREPORT_SPLIT_THRESHOLD", "1000000",
                "TASKCFG_ALL_BLOCKSIZE", "134217728",
                "TASKCFG_ALL_BLOCK_ACCESS_KEY_UPDATE_INTERVAL", "600",
                "TASKCFG_ALL_BLOCK_ACCESS_TOKEN_ENABLE", "false",
                "TASKCFG_ALL_BLOCK_ACCESS_TOKEN_LIFETIME", "600",
                "TASKCFG_ALL_BLOCK_LOCAL_PATH_ACCESS_USER", "",
                "TASKCFG_ALL_BYTES_PER_CHECKSUM", "512",
                "TASKCFG_ALL_CACHEREPORT_INTERVALMSEC", "10000",
                "TASKCFG_ALL_CLIENT_WRITE_PACKET_SIZE", "65536",
                "TASKCFG_ALL_CLIENT_BLOCK_WRITE_REPLACE_DATANODE_ON_FAILURE_BEST_EFFORT", "false",
                "TASKCFG_ALL_CLIENT_BLOCK_WRITE_REPLACE_DATANODE_ON_FAILURE_ENABLE", "true",
                "TASKCFG_ALL_CLIENT_BLOCK_WRITE_REPLACE_DATANODE_ON_FAILURE_POLICY", "DEFAULT",
                "TASKCFG_ALL_CLIENT_BLOCK_WRITE_RETRIES", "3",
                "TASKCFG_ALL_CLIENT_CACHED_CONN_RETRY", "3",
                "TASKCFG_ALL_CLIENT_CACHE_DROP_BEHIND_READS", "",
                "TASKCFG_ALL_CLIENT_CACHE_DROP_BEHIND_WRITES", "",
                "TASKCFG_ALL_CLIENT_CACHE_READAHEAD", "",
                "TASKCFG_ALL_CLIENT_DATANODE_RESTART_TIMEOUT", "30",
                "TASKCFG_ALL_CLIENT_DOMAIN_SOCKET_DATA_TRAFFIC", "false",
                "TASKCFG_ALL_CLIENT_FAILOVER_CONNECTION_RETRIES", "0",
                "TASKCFG_ALL_CLIENT_FAILOVER_CONNECTION_RETRIES_ON_TIMEOUTS", "0",
                "TASKCFG_ALL_CLIENT_FAILOVER_MAX_ATTEMPTS", "15",
                "TASKCFG_ALL_CLIENT_FAILOVER_PROXY_PROVIDER_HDFS", "org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider",
                "TASKCFG_ALL_CLIENT_FAILOVER_SLEEP_BASE_MILLIS", "500",
                "TASKCFG_ALL_CLIENT_FAILOVER_SLEEP_MAX_MILLIS", "15000",
                "TASKCFG_ALL_CLIENT_FILE_BLOCK_STORAGE_LOCATIONS_NUM_THREADS", "10",
                "TASKCFG_ALL_CLIENT_FILE_BLOCK_STORAGE_LOCATIONS_TIMEOUT_MILLIS", "1000",
                "TASKCFG_ALL_CLIENT_HTTPS_KEYSTORE_RESOURCE", "ssl-client.xml",
                "TASKCFG_ALL_CLIENT_LOCAL_INTERFACES", "",
                "TASKCFG_ALL_CLIENT_MMAP_CACHE_SIZE", "256",
                "TASKCFG_ALL_CLIENT_MMAP_CACHE_TIMEOUT_MS", "3600000",
                "TASKCFG_ALL_CLIENT_MMAP_ENABLED", "true",
                "TASKCFG_ALL_CLIENT_MMAP_RETRY_TIMEOUT_MS", "300000",
                "TASKCFG_ALL_CLIENT_READ_SHORTCIRCUIT", "true",
                "TASKCFG_ALL_CLIENT_READ_SHORTCIRCUIT_PATH", "dn_socket",
                "TASKCFG_ALL_CLIENT_READ_SHORTCIRCUIT_SKIP_CHECKSUM", "false",
                "TASKCFG_ALL_CLIENT_READ_SHORTCIRCUIT_STREAMS_CACHE_EXPIRY_MS", "300000",
                "TASKCFG_ALL_CLIENT_READ_SHORTCIRCUIT_STREAMS_CACHE_SIZE", "256",
                "TASKCFG_ALL_CLIENT_SHORT_CIRCUIT_REPLICA_STALE_THRESHOLD_MS", "1800000",
                "TASKCFG_ALL_CLIENT_SLOW_IO_WARNING_THRESHOLD_MS", "30000",
                "TASKCFG_ALL_CLIENT_USE_DATANODE_HOSTNAME", "false",
                "TASKCFG_ALL_CLIENT_WRITE_EXCLUDE_NODES_CACHE_EXPIRY_INTERVAL_MILLIS", "600000",
                "TASKCFG_ALL_DATANODE_AVAILABLE_SPACE_VOLUME_CHOOSING_POLICY_BALANCED_SPACE_PREFERENCE_FRACTION", "0.75f",
                "TASKCFG_ALL_DATANODE_AVAILABLE_SPACE_VOLUME_CHOOSING_POLICY_BALANCED_SPACE_THRESHOLD", "1.073741824E10",
                "TASKCFG_ALL_DATANODE_BALANCE_BANDWIDTHPERSEC", "1048576",
                "TASKCFG_ALL_DATANODE_BLOCK_ID_LAYOUT_UPGRADE_THREADS", "12",
                "TASKCFG_ALL_DATANODE_CACHE_REVOCATION_POLLING_MS", "500",
                "TASKCFG_ALL_DATANODE_CACHE_REVOCATION_TIMEOUT_MS", "900000",
                "TASKCFG_ALL_DATANODE_DIRECTORYSCAN_INTERVAL", "21600",
                "TASKCFG_ALL_DATANODE_DIRECTORYSCAN_THREADS", "1",
                "TASKCFG_ALL_DATANODE_DROP_CACHE_BEHIND_READS", "false",
                "TASKCFG_ALL_DATANODE_DROP_CACHE_BEHIND_WRITES", "false",
                "TASKCFG_ALL_DATANODE_DU_RESERVED", "0",
                "TASKCFG_ALL_DATANODE_FAILED_VOLUMES_TOLERATED", "0",
                "TASKCFG_ALL_DATANODE_FSDATASETCACHE_MAX_THREADS_PER_VOLUME", "4",
                "TASKCFG_ALL_DATANODE_HANDLER_COUNT", "10",
                "TASKCFG_ALL_DATANODE_HDFS_BLOCKS_METADATA_ENABLED", "false",
                "TASKCFG_ALL_DATANODE_MAX_LOCKED_MEMORY", "0",
                "TASKCFG_ALL_DATANODE_MAX_TRANSFER_THREADS", "4096",
                "TASKCFG_ALL_DATANODE_PLUGINS", "",
                "TASKCFG_ALL_DATANODE_READAHEAD_BYTES", "4193404",
                "TASKCFG_ALL_DATANODE_SHARED_FILE_DESCRIPTOR_PATHS", "/dev/shm,/tmp",
                "TASKCFG_ALL_DATANODE_SLOW_IO_WARNING_THRESHOLD_MS", "300",
                "TASKCFG_ALL_DATANODE_SYNC_BEHIND_WRITES", "false",
                "TASKCFG_ALL_DATANODE_USE_DATANODE_HOSTNAME", "false",
                "TASKCFG_ALL_DATA_NODE_HTTP_PORT", "9004",
                "TASKCFG_ALL_DATA_NODE_IPC_PORT", "9005",
                "TASKCFG_ALL_DATA_NODE_RPC_PORT", "9003",
                "TASKCFG_ALL_DATA_TRANSFER_PROTECTION", "",
                "TASKCFG_ALL_DATA_TRANSFER_SASLPROPERTIES_RESOLVER_CLASS", "",
                "TASKCFG_ALL_DEFAULT_CHUNK_VIEW_SIZE", "32768",
                "TASKCFG_ALL_DFS_HA_FENCING_SSH_CONNECT_TIMEOUT", "30000",
                "TASKCFG_ALL_DFS_HA_FENCING_SSH_PRIVATE_KEY_FILES", "",
                "TASKCFG_ALL_ENCRYPTION_KEY_PROVIDER_URI", "",
                "TASKCFG_ALL_ENCRYPT_DATA_TRANSFER", "false",
                "TASKCFG_ALL_ENCRYPT_DATA_TRANSFER_ALGORITHM", "",
                "TASKCFG_ALL_ENCRYPT_DATA_TRANSFER_CIPHER_KEY_BITLENGTH", "128",
                "TASKCFG_ALL_ENCRYPT_DATA_TRANSFER_CIPHER_SUITES", "",
                "TASKCFG_ALL_FILE_BLOCKSIZE", "67108864",
                "TASKCFG_ALL_FILE_BYTES_PER_CHECKSUM", "512",
                "TASKCFG_ALL_FILE_CLIENT_WRITE_PACKET_SIZE", "65536",
                "TASKCFG_ALL_FILE_REPLICATION", "1",
                "TASKCFG_ALL_FILE_STREAM_BUFFER_SIZE", "4096",
                "TASKCFG_ALL_FS_ABSTRACTFILESYSTEM_FILE_IMPL", "org.apache.hadoop.fs.local.LocalFs",
                "TASKCFG_ALL_FS_ABSTRACTFILESYSTEM_HAR_IMPL", "org.apache.hadoop.fs.HarFs",
                "TASKCFG_ALL_FS_ABSTRACTFILESYSTEM_HDFS_IMPL", "org.apache.hadoop.fs.Hdfs",
                "TASKCFG_ALL_FS_ABSTRACTFILESYSTEM_VIEWFS_IMPL", "org.apache.hadoop.fs.viewfs.ViewFs",
                "TASKCFG_ALL_FS_AUTOMATIC_CLOSE", "true",
                "TASKCFG_ALL_FS_CLIENT_RESOLVE_REMOTE_SYMLINKS", "true",
                "TASKCFG_ALL_FS_DF_INTERVAL", "60000",
                "TASKCFG_ALL_FS_DU_INTERVAL", "600000",
                "TASKCFG_ALL_FS_FTP_HOST", "0.0.0.0",
                "TASKCFG_ALL_FS_FTP_HOST_PORT", "21",
                "TASKCFG_ALL_FS_PERMISSIONS_UMASK_MODE", "022",
                "TASKCFG_ALL_FS_S3N_ACCESS_KEY", "",
                "TASKCFG_ALL_FS_S3N_ACL_DEFAULT", "",
                "TASKCFG_ALL_FS_S3N_ATTEMPTS_MAXIMUM", "10",
                "TASKCFG_ALL_FS_S3N_BLOCK_SIZE", "67108864",
                "TASKCFG_ALL_FS_S3N_BUFFER_DIR", "${hadoop.tmp.dir}/s3a",
                "TASKCFG_ALL_FS_S3N_CONNECTION_MAXIMUM", "15",
                "TASKCFG_ALL_FS_S3N_CONNECTION_SSL_ENABLED", "true",
                "TASKCFG_ALL_FS_S3N_CONNECTION_TIMEOUT", "5000",
                "TASKCFG_ALL_FS_S3N_IMPL", "org.apache.hadoop.fs.s3a.S3AFileSystem",
                "TASKCFG_ALL_FS_S3N_MULTIPART_COPY_BLOCK_SIZE", "5.36870912E9",
                "TASKCFG_ALL_FS_S3N_MULTIPART_PURGE", "false",
                "TASKCFG_ALL_FS_S3N_MULTIPART_PURGE_AGE", "86400",
                "TASKCFG_ALL_FS_S3N_MULTIPART_SIZE", "104857600",
                "TASKCFG_ALL_FS_S3N_MULTIPART_THRESHOLD", "2147483647",
                "TASKCFG_ALL_FS_S3N_MULTIPART_UPLOADS_BLOCK_SIZE", "67108864",
                "TASKCFG_ALL_FS_S3N_MULTIPART_UPLOADS_ENABLED", "false",
                "TASKCFG_ALL_FS_S3N_PAGING_MAXIMUM", "5000",
                "TASKCFG_ALL_FS_S3N_SECRET_KEY", "",
                "TASKCFG_ALL_FS_S3N_SERVER_SIDE_ENCRPYTION_ALGORITHM", "",
                "TASKCFG_ALL_FS_S3_BLOCK_SIZE", "67108864",
                "TASKCFG_ALL_FS_S3_BUFFER_DIR", "${hadoop.tmp.dir}/s3",
                "TASKCFG_ALL_FS_S3_MAXRETRIES", "4",
                "TASKCFG_ALL_FS_S3_SLEEP_TIME_SECONDS", "10",
                "TASKCFG_ALL_FS_SWIFT_IMPL", "org.apache.hadoop.fs.swift.snative.SwiftNativeFileSystem",
                "TASKCFG_ALL_FS_TRASH_CHECKPOINT_INTERVAL", "0",
                "TASKCFG_ALL_FS_TRASH_INTERVAL", "0",
                "TASKCFG_ALL_FTP_BLOCKSIZE", "67108864",
                "TASKCFG_ALL_FTP_BYTES_PER_CHECKSUM", "512",
                "TASKCFG_ALL_FTP_CLIENT_WRITE_PACKET_SIZE", "65536",
                "TASKCFG_ALL_FTP_REPLICATION", "3",
                "TASKCFG_ALL_FTP_STREAM_BUFFER_SIZE", "4096",
                "TASKCFG_ALL_FUSE_CONNECTION_TIMEOUT", "300",
                "TASKCFG_ALL_FUSE_TIMER_PERIOD", "5",
                "TASKCFG_ALL_HADOOP_COMMON_CONFIGURATION_VERSION", "0.23.0",
                "TASKCFG_ALL_HADOOP_HDFS_CONFIGURATION_VERSION", "1",
                "TASKCFG_ALL_HADOOP_HTTP_AUTHENTICATION_COOKIE_DOMAIN", "",
                "TASKCFG_ALL_HADOOP_HTTP_AUTHENTICATION_KERBEROS_KEYTAB", "${user.home}/hadoop.keytab",
                "TASKCFG_ALL_HADOOP_HTTP_AUTHENTICATION_KERBEROS_PRINCIPAL", "HTTP/_HOST@LOCALHOST",
                "TASKCFG_ALL_HADOOP_HTTP_AUTHENTICATION_SIGNATURE_SECRET_FILE", "${user.home}/hadoop-http-auth-signature-secret",
                "TASKCFG_ALL_HADOOP_HTTP_AUTHENTICATION_SIMPLE_ANONYMOUS_ALLOWED", "true",
                "TASKCFG_ALL_HADOOP_HTTP_AUTHENTICATION_TOKEN_VALIDITY", "36000",
                "TASKCFG_ALL_HADOOP_HTTP_AUTHENTICATION_TYPE", "simple",
                "TASKCFG_ALL_HADOOP_HTTP_FILTER_INITIALIZER", "org.apache.hadoop.http.lib.StaticUserWebFilter",
                "TASKCFG_ALL_HADOOP_HTTP_STATICUSER_USER", "dr.who",
                "TASKCFG_ALL_HADOOP_JETTY_LOGS_SERVE_ALIASES", "false",
                "TASKCFG_ALL_HADOOP_KERBEROS_KINIT_COMMAND", "kinit",
                "TASKCFG_ALL_HADOOP_NAMENODE_OPTS", "",
                "TASKCFG_ALL_HADOOP_PROXYUSER_HTTPFS_GROUPS", "*",
                "TASKCFG_ALL_HADOOP_PROXYUSER_HTTPFS_HOSTS", "*",
                "TASKCFG_ALL_HADOOP_PROXYUSER_HUE_GROUPS", "*",
                "TASKCFG_ALL_HADOOP_PROXYUSER_HUE_HOSTS", "*",
                "TASKCFG_ALL_HADOOP_PROXYUSER_ROOT_GROUPS", "*",
                "TASKCFG_ALL_HADOOP_PROXYUSER_ROOT_HOSTS", "*",
                "TASKCFG_ALL_HADOOP_ROOT_LOGGER", "INFO,console",
                "TASKCFG_ALL_HADOOP_RPC_PROTECTION", "authentication",
                "TASKCFG_ALL_HADOOP_RPC_SOCKET_FACTORY_CLASS_CLIENT_PROTOCOL", "",
                "TASKCFG_ALL_HADOOP_RPC_SOCKET_FACTORY_CLASS_DEFAULT", "org.apache.hadoop.net.StandardSocketFactory",
                "TASKCFG_ALL_HADOOP_SECURITY_AUTHENTICATION", "simple",
                "TASKCFG_ALL_HADOOP_SECURITY_AUTHORIZATION", "false",
                "TASKCFG_ALL_HADOOP_SECURITY_AUTH_TO_LOCAL", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUPS_CACHE_SECS", "300",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUPS_CACHE_WARN_AFTER_MS", "5000",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUPS_NEGATIVE_CACHE_SECS", "30",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING", "org.apache.hadoop.security.JniBasedUnixGroupsMappingWithFallback",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_BASE", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_BIND_USER", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_DIRECTORY_SEARCH_TIMEOUT", "10000",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_PASSWORD_FILE", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_SEARCH_ATTR_GROUP_NAME", "cn",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_SEARCH_ATTR_MEMBER", "member",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_SEARCH_FILTER_GROUP", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_SEARCH_FILTER_USER", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_SSL", "false",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_SSL_KEYSTORE", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_SSL_KEYSTORE_PASSWORD_FILE", "",
                "TASKCFG_ALL_HADOOP_SECURITY_GROUP_MAPPING_LDAP_URL", "",
                "TASKCFG_ALL_HADOOP_SECURITY_IMPERSONATION_PROVIDER_CLASS", "",
                "TASKCFG_ALL_HADOOP_SECURITY_INSTRUMENTATION_REQUIRES_ADMIN", "false",
                "TASKCFG_ALL_HADOOP_SECURITY_SASLPROPERTIES_RESOLVER_CLASS", "",
                "TASKCFG_ALL_HADOOP_SECURITY_SERVICE_USER_NAME_KEY", "",
                "TASKCFG_ALL_HADOOP_SECURITY_UID_CACHE_SECS", "14400",
                "TASKCFG_ALL_HADOOP_SOCKS_SERVER", "",
                "TASKCFG_ALL_HADOOP_SSL_KEYSTORES_FACTORY_CLASS", "org.apache.hadoop.security.ssl.FileBasedKeyStoresFactory",
                "TASKCFG_ALL_HADOOP_SSL_REQUIRE_CLIENT_CERT", "false",
                "TASKCFG_ALL_HADOOP_TMP_DIR", "/tmp/hadoop-${user.name}",
                "TASKCFG_ALL_HADOOP_USER_GROUP_STATIC_MAPPING_OVERRIDES", "",
                "TASKCFG_ALL_HADOOP_UTIL_HASH_TYPE", "murmur",
                "TASKCFG_ALL_HADOOP_WORK_AROUND_NON_THREADSAFE_GETPWUID", "false",
                "TASKCFG_ALL_HA_AUTOMATIC_FAILURE", "true",
                "TASKCFG_ALL_HA_FAILOVER_CONTROLLER_CLI_CHECK_RPC_TIMEOUT_MS", "20000",
                "TASKCFG_ALL_HA_FAILOVER_CONTROLLER_GRACEFUL_FENCE_CONNECTION_RETRIES", "1",
                "TASKCFG_ALL_HA_FAILOVER_CONTROLLER_GRACEFUL_FENCE_RPC_TIMEOUT_MS", "5000",
                "TASKCFG_ALL_HA_FAILOVER_CONTROLLER_NEW_ACTIVE_RPC_TIMEOUT_MS", "60000",
                "TASKCFG_ALL_HA_FENCING_METHODS", "shell(/bin/true)",
                "TASKCFG_ALL_HA_HEALTH_MONITOR_CHECK_INTERVAL_MS", "1000",
                "TASKCFG_ALL_HA_HEALTH_MONITOR_CONNECT_RETRY_INTERVAL_MS", "1000",
                "TASKCFG_ALL_HA_HEALTH_MONITOR_RPC_TIMEOUT_MS", "45000",
                "TASKCFG_ALL_HA_HEALTH_MONITOR_SLEEP_AFTER_DISCONNECT_MS", "1000",
                "TASKCFG_ALL_HA_LOG_ROLL_PERIOD", "120",
                "TASKCFG_ALL_HA_TAIL_EDITS_PERIOD", "60",
                "TASKCFG_ALL_HA_ZOOKEEPER_SESSION_TIMEOUT_MS", "5000",
                "TASKCFG_ALL_HEARTBEAT_INTERVAL", "3",
                "TASKCFG_ALL_HOSTS", "",
                "TASKCFG_ALL_HOSTS_EXCLUDE", "",
                "TASKCFG_ALL_HTTPS_SERVER_KEYSTORE_RESOURCE", "ssl-server.xml",
                "TASKCFG_ALL_IMAGE_COMPRESS", "true",
                "TASKCFG_ALL_IMAGE_COMPRESSION_CODEC", "org.apache.hadoop.io.compress.SnappyCodec",
                "TASKCFG_ALL_IMAGE_TRANSFER_BANDWIDTHPERSEC", "0",
                "TASKCFG_ALL_IMAGE_TRANSFER_CHUNKSIZE", "65536",
                "TASKCFG_ALL_IMAGE_TRANSFER_TIMEOUT", "60000",
                "TASKCFG_ALL_IO_BYTES_PER_CHECKSUM", "512",
                "TASKCFG_ALL_IO_COMPRESSION_CODECS", "",
                "TASKCFG_ALL_IO_COMPRESSION_CODEC_BZIP2_LIBRARY", "system-native",
                "TASKCFG_ALL_IO_FILE_BUFFER_SIZE", "4096",
                "TASKCFG_ALL_IO_MAP_INDEX_INTERVAL", "128",
                "TASKCFG_ALL_IO_MAP_INDEX_SKIP", "0",
                "TASKCFG_ALL_IO_SEQFILE_BLOOM_ERROR_RATE", "0.005",
                "TASKCFG_ALL_IO_SEQFILE_BLOOM_SIZE", "1048576",
                "TASKCFG_ALL_IO_SEQFILE_COMPRESS_BLOCKSIZE", "1000000",
                "TASKCFG_ALL_IO_SEQFILE_LAZYDECOMPRESS", "true",
                "TASKCFG_ALL_IO_SEQFILE_LOCAL_DIR", "${hadoop.tmp.dir}/io/local",
                "TASKCFG_ALL_IO_SEQFILE_SORTER_RECORDLIMIT", "1000000",
                "TASKCFG_ALL_IO_SERIALIZATIONS", "org.apache.hadoop.io.serializer.WritableSerialization,org.apache.hadoop.io.serializer.avro.AvroSpecificSerialization,org.apache.hadoop.io.serializer.avro.AvroReflectSerialization",
                "TASKCFG_ALL_IO_SKIP_CHECKSUM_ERRORS", "false",
                "TASKCFG_ALL_IPC_CLIENT_CONNECTION_MAXIDLETIME", "10000",
                "TASKCFG_ALL_IPC_CLIENT_CONNECT_MAX_RETRIES", "300",
                "TASKCFG_ALL_IPC_CLIENT_CONNECT_MAX_RETRIES_ON_TIMEOUTS", "45",
                "TASKCFG_ALL_IPC_CLIENT_CONNECT_RETRY_INTERVAL", "1000",
                "TASKCFG_ALL_IPC_CLIENT_CONNECT_TIMEOUT", "20000",
                "TASKCFG_ALL_IPC_CLIENT_FALLBACK_TO_SIMPLE_AUTH_ALLOWED", "false",
                "TASKCFG_ALL_IPC_CLIENT_IDLETHRESHOLD", "4000",
                "TASKCFG_ALL_IPC_CLIENT_KILL_MAX", "10",
                "TASKCFG_ALL_IPC_SERVER_LISTEN_QUEUE_SIZE", "45",
                "TASKCFG_ALL_JOURNAL_NODE_HTTP_PORT", "8480",
                "TASKCFG_ALL_JOURNAL_NODE_RPC_PORT", "8485",
                "TASKCFG_ALL_JOURNAL_READINESS_CHECK_ENABLED", "true",
                "TASKCFG_ALL_JRE_VERSION", "jre1.8.0_131",
                "TASKCFG_ALL_METRICS_PERCENTILES_INTERVALS", "",
                "TASKCFG_ALL_NAMENODE_ACCESSTIME_PRECISION", "3600000",
                "TASKCFG_ALL_NAMENODE_ACLS_ENABLED", "false",
                "TASKCFG_ALL_NAMENODE_AUDIT_LOGGERS", "default",
                "TASKCFG_ALL_NAMENODE_AVOID_READ_STALE_DATANODE", "false",
                "TASKCFG_ALL_NAMENODE_AVOID_WRITE_STALE_DATANODE", "false",
                "TASKCFG_ALL_NAMENODE_CHECKPOINT_CHECK_PERIOD", "60",
                "TASKCFG_ALL_NAMENODE_CHECKPOINT_MAX_RETRIES", "3",
                "TASKCFG_ALL_NAMENODE_CHECKPOINT_PERIOD", "3600",
                "TASKCFG_ALL_NAMENODE_CHECKPOINT_TXNS", "1000000",
                "TASKCFG_ALL_NAMENODE_DECOMMISSION_BLOCKS_PER_INTERVAL", "500000",
                "TASKCFG_ALL_NAMENODE_DECOMMISSION_INTERVAL", "30",
                "TASKCFG_ALL_NAMENODE_DELEGATION_KEY_UPDATE_INTERVAL", "86400000",
                "TASKCFG_ALL_NAMENODE_DELEGATION_TOKEN_MAX_LIFETIME", "604800000",
                "TASKCFG_ALL_NAMENODE_EDITS_NOEDITLOGCHANNELFLUSH", "false",
                "TASKCFG_ALL_NAMENODE_EDIT_LOG_AUTOROLL_CHECK_INTERVAL_MS", "300000",
                "TASKCFG_ALL_NAMENODE_EDIT_LOG_AUTOROLL_MULTIPLIER_THRESHOLD", "2",
                "TASKCFG_ALL_NAMENODE_ENABLE_RETRYCACHE", "true",
                "TASKCFG_ALL_NAMENODE_FS_LIMITS_MAX_ATTRS_PER_INODE", "32",
                "TASKCFG_ALL_NAMENODE_FS_LIMITS_MAX_ATTRS_SIZE", "16384",
                "TASKCFG_ALL_NAMENODE_FS_LIMITS_MAX_BLOCKS_PER_FILE", "1048576",
                "TASKCFG_ALL_NAMENODE_FS_LIMITS_MAX_COMPONENT_LENGTH", "255",
                "TASKCFG_ALL_NAMENODE_FS_LIMITS_MAX_DIRECTORY_ITEMS", "1048576",
                "TASKCFG_ALL_NAMENODE_FS_LIMITS_MIN_BLOCK_SIZE", "1048576",
                "TASKCFG_ALL_NAMENODE_HANDLER_COUNT", "10",
                "TASKCFG_ALL_NAMENODE_HEARTBEAT_RECHECK_INTERVAL", "60000",
                "TASKCFG_ALL_NAMENODE_INOTIFY_MAX_EVENTS_PER_RPC", "1000",
                "TASKCFG_ALL_NAMENODE_INVALIDATE_WORK_PCT_PER_ITERATION", "0.32f",
                "TASKCFG_ALL_NAMENODE_LAZYPERSIST_FILE_SCRUB_INTERVAL_SEC", "300",
                "TASKCFG_ALL_NAMENODE_LEGACY_OIV_IMAGE_DIR", "",
                "TASKCFG_ALL_NAMENODE_LIST_CACHE_DIRECTIVES_NUM_RESPONSES", "100",
                "TASKCFG_ALL_NAMENODE_LIST_CACHE_POOLS_NUM_RESPONSES", "100",
                "TASKCFG_ALL_NAMENODE_LIST_ENCRYPTION_ZONES_NUM_RESPONSES", "100",
                "TASKCFG_ALL_NAMENODE_LOGGING_LEVEL", "info",
                "TASKCFG_ALL_NAMENODE_MAX_EXTRA_EDITS_SEGMENTS_RETAINED", "10000",
                "TASKCFG_ALL_NAMENODE_MAX_OBJECTS", "0",
                "TASKCFG_ALL_NAMENODE_NAME_DIR_RESTORE", "false",
                "TASKCFG_ALL_NAMENODE_NUM_CHECKPOINTS_RETAINED", "2",
                "TASKCFG_ALL_NAMENODE_NUM_EXTRA_EDITS_RETAINED", "1000000",
                "TASKCFG_ALL_NAMENODE_PATH_BASED_CACHE_BLOCK_MAP_ALLOCATION_PERCENT", "0.25",
                "TASKCFG_ALL_NAMENODE_PATH_BASED_CACHE_REFRESH_INTERVAL_MS", "30000",
                "TASKCFG_ALL_NAMENODE_PATH_BASED_CACHE_RETRY_INTERVAL_MS", "30000",
                "TASKCFG_ALL_NAMENODE_PLUGINS", "",
                "TASKCFG_ALL_NAMENODE_REJECT_UNRESOLVED_DN_TOPOLOGY_MAPPING", "false",
                "TASKCFG_ALL_NAMENODE_REPLICATION_CONSIDERLOAD", "true",
                "TASKCFG_ALL_NAMENODE_REPLICATION_INTERVAL", "3",
                "TASKCFG_ALL_NAMENODE_REPLICATION_MIN", "1",
                "TASKCFG_ALL_NAMENODE_REPLICATION_WORK_MULTIPLIER_PER_ITERATION", "2",
                "TASKCFG_ALL_NAMENODE_RESOURCE_CHECKED_VOLUMES", "",
                "TASKCFG_ALL_NAMENODE_RESOURCE_CHECKED_VOLUMES_MINIMUM", "1",
                "TASKCFG_ALL_NAMENODE_RESOURCE_CHECK_INTERVAL", "5000",
                "TASKCFG_ALL_NAMENODE_RESOURCE_DU_RESERVED", "104857600",
                "TASKCFG_ALL_NAMENODE_RETRYCACHE_EXPIRYTIME_MILLIS", "600000",
                "TASKCFG_ALL_NAMENODE_RETRYCACHE_HEAP_PERCENT", "0.03f",
                "TASKCFG_ALL_NAMENODE_SAFEMODE_EXTENSION", "30000",
                "TASKCFG_ALL_NAMENODE_SAFEMODE_MIN_DATANODES", "0",
                "TASKCFG_ALL_NAMENODE_SAFEMODE_THRESHOLD_PCT", "0.999f",
                "TASKCFG_ALL_NAMENODE_STALE_DATANODE_INTERVAL", "30000",
                "TASKCFG_ALL_NAMENODE_STARTUP_DELAY_BLOCK_DELETION_SEC", "0",
                "TASKCFG_ALL_NAMENODE_SUPPORT_ALLOW_FORMAT", "true",
                "TASKCFG_ALL_NAMENODE_WRITE_STALE_DATANODE_RATIO", "0.5f",
                "TASKCFG_ALL_NAMENODE_XATTRS_ENABLED", "true",
                "TASKCFG_ALL_NAME_NODE_HTTP_PORT", "9002",
                "TASKCFG_ALL_NAME_NODE_RPC_PORT", "9001",
                "TASKCFG_ALL_NET_TOPOLOGY_IMPL", "org.apache.hadoop.net.NetworkTopology",
                "TASKCFG_ALL_NET_TOPOLOGY_NODE_SWITCH_MAPPING_IMPL", "org.apache.hadoop.net.ScriptBasedMapping",
                "TASKCFG_ALL_NET_TOPOLOGY_SCRIPT_FILE_NAME", "",
                "TASKCFG_ALL_NET_TOPOLOGY_SCRIPT_NUMBER_ARGS", "100",
                "TASKCFG_ALL_NET_TOPOLOGY_TABLE_FILE_NAME", "",
                "TASKCFG_ALL_NFS_EXPORTS_ALLOWED_HOSTS", "* rw",
                "TASKCFG_ALL_PERMISSIONS_ENABLED", "false",
                "TASKCFG_ALL_PERMISSIONS_SUPERUSERGROUP", "supergroup",
                "TASKCFG_ALL_REGISTRATION_IP_HOSTNAME_CHECK", "false",
                "TASKCFG_ALL_REPLICATION", "3",
                "TASKCFG_ALL_REPLICATION_MAX", "512",
                "TASKCFG_ALL_RPC_METRICS_PERCENTILES_INTERVALS", "",
                "TASKCFG_ALL_RPC_METRICS_QUANTILE_ENABLE", "false",
                "TASKCFG_ALL_S3NATIVE_BLOCKSIZE", "67108864",
                "TASKCFG_ALL_S3NATIVE_BYTES_PER_CHECKSUM", "512",
                "TASKCFG_ALL_S3NATIVE_CLIENT_WRITE_PACKET_SIZE", "65536",
                "TASKCFG_ALL_S3NATIVE_REPLICATION", "3",
                "TASKCFG_ALL_S3NATIVE_STREAM_BUFFER_SIZE", "4096",
                "TASKCFG_ALL_S3_BLOCKSIZE", "67108864",
                "TASKCFG_ALL_S3_BYTES_PER_CHECKSUM", "512",
                "TASKCFG_ALL_S3_CLIENT_WRITE_PACKET_SIZE", "65536",
                "TASKCFG_ALL_S3_REPLICATION", "3",
                "TASKCFG_ALL_S3_STREAM_BUFFER_SIZE", "4096",
                "TASKCFG_ALL_SHORT_CIRCUIT_SHARED_MEMORY_WATCHER_INTERRUPT_CHECK_MS", "60000",
                "TASKCFG_ALL_STORAGE_POLICY_ENABLED", "true",
                "TASKCFG_ALL_STREAM_BUFFER_SIZE", "4096",
                "TASKCFG_ALL_SUPPORT_APPEND", "true",
                "TASKCFG_ALL_TASK_USER", "nobody",
                "TASKCFG_ALL_TFILE_FS_INPUT_BUFFER_SIZE", "262144",
                "TASKCFG_ALL_TFILE_IO_CHUNK_SIZE", "1048576",
                "TASKCFG_ALL_TFILE_IO_OUTPUT_BUFFER_SIZE", "262144",
                "TASKCFG_ALL_TRUSTEDCHANNEL_RESOLVER_CLASS", "",
                "TASKCFG_ALL_WEBHDFS_ENABLED", "true",
                "TASKCFG_ALL_WEBHDFS_USER_PROVIDER_USER_PATTERN", "^[A-Za-z_][A-Za-z0-9._-]*[$]?$",
                "TASKCFG_ALL_ZKFC_PORT", "8019",
                "UPDATE_STRATEGY", "serial",
                "ZKFC_CPUS", "0.3",
                "ZKFC_MEM", "204"
        );
    }

    @Test
    public void testYaml() throws Exception {
        super.testYaml("svc.yml");
    }

    @Test
    public void testRenderHdfsSiteXml() throws IOException {
        renderTemplate(System.getProperty("user.dir") + "/src/main/dist/hdfs-site.xml");
    }

    @Test
    public void testRenderCoreSiteXml() throws IOException {
        renderTemplate(System.getProperty("user.dir") + "/src/main/dist/core-site.xml");
    }

    private void renderTemplate(String pathStr) throws IOException {
        String fileStr = new String(Files.readAllBytes(Paths.get(pathStr)), StandardCharsets.UTF_8);

        // Reproduction of what's added to tasks automatically, and in Main.java:
        Map<String, String> updatedEnv = new TaskEnvRouter(envVars).getConfig("ALL");
        updatedEnv.put(EnvConstants.FRAMEWORK_HOST_TASKENV, "hdfs.on.some.cluster");
        updatedEnv.put("MESOS_SANDBOX", "/mnt/sandbox");
        updatedEnv.put("SERVICE_ZK_ROOT", "/dcos-service-path__to__hdfs");

        // Throw when a value is missing:
        TemplateUtils.applyEnvToMustache(pathStr, fileStr, updatedEnv, TemplateUtils.MissingBehavior.EXCEPTION);
    }
}
